@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix ex: <http://example.org/shapes#> .
@prefix obo: <http://purl.obolibrary.org/obo/> .
@prefix sio: <http://semanticscience.org/resource/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix ordo: <http://www.orpha.net/ORDO/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

ex:ClinicalRecordShape a sh:NodeShape ;
  sh:targetSubjectsOf rdf:type ;  # or use sh:targetClass sio:SIO_001027 if desired
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "Clinical record structure does not meet requirements." ;
    sh:select """
      SELECT DISTINCT ?record
      WHERE {
        GRAPH ?record {
          ?person sio:SIO_000228 ?role .
          ?role a sio:SIO_000016 ;
                sio:SIO_000356 ?process .
              
          ?id sio:SIO_000020 ?role ;
              sio:SIO_000300 ?patient_id .

          ?process a ?process_type ;
                   sio:SIO_000229 ?output ;
                   sio:SIO_000291 ?target ;
                   sio:SIO_000230 ?input ;
                   sio:SIO_000339 ?protocol ;
                   sio:SIO_000028 ?specific_method .
          FILTER(?process_type != sio:SIO_000006)

          OPTIONAL { ?process rdfs:comments ?comments }

          ?output a sio:SIO_000015 ;
                  sio:SIO_000628 ?attribute ;
                  sio:SIO_000671 ?output_identifier .
          OPTIONAL { ?output sio:SIO_000300 ?value }

          ?attribute a sio:SIO_000614 .

          ?output_identifier a sio:SIO_000115 .
          OPTIONAL { ?output_identifier sio:SIO_000300 ?value_output_identifier }

          ?input a sio:SIO_000015 .
          ?target a sio:SIO_000015 .
          ?specific_method a sio:SIO_000006 .

          ?protocol a sio:SIO_000090 ;
                    sio:SIO_000028 ?frequency, ?substance, ?concentration .

          ?substance a sio:SIO_000315 .
          ?concentration a sio:SIO_001088 .
          OPTIONAL { ?concentration sio:SIO_000300 ?concentration_value }

          ?frequency a sio:SIO_001367 .
          OPTIONAL { ?frequency sio:SIO_000300 ?frequency_value }
        }

        ?record a sio:SIO_001027 ;
                rdfs:label ?record_label ;
                sio:SIO_000680 ?startdate ;
                sio:SIO_000681 ?enddate ;
                sio:SIO_000687 ?age ;
                sio:SIO_000300 ?uniqid ;
                sio:SIO_000068 ?medical_history, ?event .

        ?medical_history a sio:SIO_010673 ;
                         sio:SIO_000332 ?person_timeline .
        ?person_timeline a sio:SIO_000498 ;
                         sio:SIO_000671 ?person_identifier .
        ?person_identifier a sio:SIO_000115 ;
                           sio:SIO_000300 ?pid .

        ?event a sio:SIO_000088 .
        OPTIONAL { ?event sio:SIO_000300 ?event_id }

        ?age a sio:SIO_001013 .
        ?startdate a sio:SIO_000031 .
        ?enddate a sio:SIO_000032 .
        OPTIONAL { ?age sio:SIO_000300 ?age_value }
        OPTIONAL { ?startdate sio:SIO_000300 ?value_startdate }
        OPTIONAL { ?enddate sio:SIO_000300 ?value_enddate }
      }
    """ ;
  ] .
